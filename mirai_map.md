
# mirai

#### Comparison of `mirai::mirai_map()` with `purrr::map()`

Setup:

``` r
library(purrr)
library(mirai)
daemons(2)
#> [1] 2
```

Basic example (identical):

``` r
1:10 |>
  map(\(x) rnorm(10, x))
#> [[1]]
#>  [1]  1.3827295  1.0616249  0.5286172  0.5271836 -1.0338904  1.6832981
#>  [7]  0.4232926  0.8767888  2.0635379  1.6234678
#> 
#> [[2]]
#>  [1] 3.00501897 0.05350397 1.13108646 0.92696550 1.85543092 2.38825365
#>  [7] 3.90916951 1.45571666 1.45055936 0.36488245
#> 
#> [[3]]
#>  [1] 4.646539 2.958302 2.673248 3.604084 1.794584 3.625819 1.881632 4.310400
#>  [9] 4.693653 2.259260
#> 
#> [[4]]
#>  [1] 3.401702 5.027200 3.490281 3.001989 4.032975 2.835230 3.999839 4.968993
#>  [9] 4.393368 3.476220
#> 
#> [[5]]
#>  [1] 3.980543 5.122026 4.283554 4.469102 4.787964 5.330581 3.926631 5.343619
#>  [9] 5.496312 4.171468
#> 
#> [[6]]
#>  [1] 6.892638 8.650483 5.842156 7.996595 5.507208 5.453659 5.684800 6.903252
#>  [9] 7.120319 6.809663
#> 
#> [[7]]
#>  [1] 7.525868 7.345514 6.943540 7.481246 8.384463 8.333092 5.385730 7.381409
#>  [9] 7.700192 6.573494
#> 
#> [[8]]
#>  [1] 7.291955 6.536898 7.644002 8.004797 8.082639 6.943957 7.334476 6.742866
#>  [9] 8.935621 8.509404
#> 
#> [[9]]
#>  [1]  9.181139  9.442147 10.083610  7.578178 10.662185 10.905118  9.301995
#>  [8]  8.609628  7.495630  9.610684
#> 
#> [[10]]
#>  [1] 10.159590 11.342186  9.317329 10.887237  9.540012 10.155029  8.812320
#>  [8]  9.787170 10.197342  9.518752

1:10 |>
  mirai_map(\(x) rnorm(10, x)) |>
  collect_mirai()
#> [[1]]
#>  [1] 2.5789749 0.7931995 0.2408810 1.3049818 0.1145831 1.1843336 1.1619072
#>  [8] 2.4224551 0.7133933 1.2526171
#> 
#> [[2]]
#>  [1] 2.901947 2.763096 1.000868 2.650090 0.859709 1.404885 1.687289 1.342538
#>  [9] 2.716988 1.855881
#> 
#> [[3]]
#>  [1] 2.795538 1.679283 4.262698 2.704870 4.430597 1.794651 3.955659 4.009845
#>  [9] 3.138349 3.003124
#> 
#> [[4]]
#>  [1] 3.624508 2.824549 5.377501 5.145537 4.170698 4.476080 4.940548 3.649883
#>  [9] 4.733188 4.007125
#> 
#> [[5]]
#>  [1] 5.093371 5.176199 4.004461 3.805996 5.229339 4.906833 5.491299 5.073514
#>  [9] 6.409686 5.310653
#> 
#> [[6]]
#>  [1] 6.174116 7.431369 6.777685 4.681280 7.514517 5.663315 6.198769 4.648960
#>  [9] 5.838463 6.681525
#> 
#> [[7]]
#>  [1] 8.014206 6.102457 6.692763 6.104122 5.994220 8.760353 6.120304 6.388336
#>  [9] 7.056375 7.354541
#> 
#> [[8]]
#>  [1] 7.259450 8.322937 8.129539 9.864524 8.625541 7.290481 8.755643 8.722772
#>  [9] 8.346550 9.013426
#> 
#> [[9]]
#>  [1] 10.352488 10.289340 11.541280  9.183642  7.775697  9.470253  7.905693
#>  [8]  7.796684 10.377674  8.946799
#> 
#> [[10]]
#>  [1] 10.880961  9.609883 10.949484 10.836373 10.693146 10.841912 11.071371
#>  [8]  9.231364  9.529054  8.898498
```

With cli progress bar (identical):

``` r
1:10 |>
  map(\(x) {Sys.sleep(0.5); rnorm(10, x)}, .progress = TRUE)
#> ■■■■■■■ 20% | ETA: 4s ■■■■■■■■■■ 30% | ETA: 4s ■■■■■■■■■■■■■ 40% | ETA: 3s
#> ■■■■■■■■■■■■■■■■ 50% | ETA: 3s ■■■■■■■■■■■■■■■■■■■ 60% | ETA: 2s
#> ■■■■■■■■■■■■■■■■■■■■■■ 70% | ETA: 2s ■■■■■■■■■■■■■■■■■■■■■■■■■ 80% | ETA: 1s
#> ■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 90% | ETA: 1s
#> [[1]]
#>  [1] -0.19603980  1.50487174  0.52159066 -0.06234154  1.00389375  1.86121170
#>  [7]  0.91075890  1.31625226  1.07403013 -0.29417865
#> 
#> [[2]]
#>  [1] 2.468906 1.030084 2.232355 2.504909 1.878072 2.948504 1.704255 2.740091
#>  [9] 3.785992 1.217300
#> 
#> [[3]]
#>  [1] 3.125279 2.496104 1.476699 2.623316 2.757526 2.678350 3.354520 2.926159
#>  [9] 3.919627 3.209252
#> 
#> [[4]]
#>  [1] 2.143650 2.821325 4.989759 4.748025 1.929683 2.385748 4.980934 3.352405
#>  [9] 5.151830 3.696067
#> 
#> [[5]]
#>  [1] 6.171842 3.696881 3.651040 6.301204 4.946308 4.915168 5.243145 4.770738
#>  [9] 5.549428 4.239876
#> 
#> [[6]]
#>  [1] 5.289769 5.897064 5.316960 5.752860 7.481791 5.152593 5.610132 7.724313
#>  [9] 5.962537 6.178588
#> 
#> [[7]]
#>  [1] 7.685224 7.268887 7.374528 6.566017 8.122990 6.589770 5.905866 4.981572
#>  [9] 6.576643 8.256031
#> 
#> [[8]]
#>  [1] 8.626560 8.083866 8.904051 7.967479 9.127321 6.753577 7.749142 8.468060
#>  [9] 7.009227 6.915371
#> 
#> [[9]]
#>  [1]  9.740822 10.526634 10.256415  8.815489  9.334976  8.567580  8.859028
#>  [8]  8.013582 10.249114  7.846523
#> 
#> [[10]]
#>  [1]  8.052955 10.998274  7.086915  9.236476 10.250222  8.382929  8.399918
#>  [8]  9.316235  9.915704 10.439715

1:10 |>
  mirai_map(\(x) {Sys.sleep(0.5); rnorm(10, x)}) |>
  collect_mirai(.progress_cli)
#> ■■■■■■■■■■ 30% | ETA: 2s■■■■■■■■■■■■■■■■ 50% | ETA: 2s■■■■■■■■■■■■■■■■■■■■■■
#> 70% | ETA: 1s■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 90% | ETA: 0s
#> [[1]]
#>  [1] -0.2536842  1.3861940  0.1899631  1.6394253  1.4981674  2.9213697
#>  [7]  1.1614028  0.1285323  2.1440299  0.1540598
#> 
#> [[2]]
#>  [1]  2.2567647 -0.2507772  2.2866189  1.7949563  2.9135412  1.5727876
#>  [7]  2.2411206  3.8905205  0.9137870  1.8074850
#> 
#> [[3]]
#>  [1]  4.4636508  2.0539674  5.1025499  2.6163194  3.0662357  2.8975517
#>  [7] -0.3537649  4.6329035  3.1898415  3.8649867
#> 
#> [[4]]
#>  [1] 4.479510 4.208635 4.724196 3.034924 5.664116 2.777305 3.383790 2.970703
#>  [9] 4.670962 3.881007
#> 
#> [[5]]
#>  [1] 4.679448 3.857096 4.953824 5.337872 3.042156 5.715123 5.698754 6.032798
#>  [9] 4.811351 1.803291
#> 
#> [[6]]
#>  [1] 5.149401 3.992447 6.982107 6.653326 7.808582 6.330768 5.822252 6.487930
#>  [9] 5.154701 5.239220
#> 
#> [[7]]
#>  [1] 6.219917 7.929910 7.916484 5.316823 6.676716 6.538275 6.119724 5.872011
#>  [9] 6.266581 7.152411
#> 
#> [[8]]
#>  [1] 7.073654 6.174597 9.283638 6.471939 5.796453 7.246294 9.026031 7.056110
#>  [9] 8.378626 8.488477
#> 
#> [[9]]
#>  [1]  8.673834  7.832164  9.432995 10.227549  9.936000  9.204716 10.119002
#>  [8]  9.167418  5.797433 10.201413
#> 
#> [[10]]
#>  [1]  8.682732  9.507948 11.392742  8.829433 11.127680  9.684411 10.432909
#>  [8]  9.203836 11.016436 11.621499
```

Error handling (output currently not as rich):

``` r
1:10 |>
  map(\(x) if (x != 10) rnorm(10, x) else rlang::abort("stopped", meta = "uid"))
#> Error in `map()`:
#> ℹ In index: 10.
#> Caused by error in `.f()`:
#> ! stopped

1:10 |>
  mirai_map(\(x) if (x != 10) rnorm(10, x) else rlang::abort("stopped", meta = "uid")) |>
  collect_mirai(.stop)
#> Error: Error in (function (x) : stopped
```

Additional async features:

1.  Can recover non-errored portions if not using early stopping:

``` r
1:10 |>
  mirai_map(\(x) if (x != 10) rnorm(10, x) else rlang::abort("stopped", meta = "uid")) |>
  collect_mirai()
#> [[1]]
#>  [1] 0.1477184 0.6594558 3.0578241 0.2753769 1.5642637 1.7951149 0.9115827
#>  [8] 1.2137647 0.1414448 2.8052327
#> 
#> [[2]]
#>  [1] 2.844919 2.196568 1.023770 2.313186 2.719208 2.348613 2.517244 3.429756
#>  [9] 2.559826 3.116534
#> 
#> [[3]]
#>  [1] 2.2789636 2.8678064 2.7756722 4.4880870 2.3691080 3.0443525 4.0665860
#>  [8] 3.6078993 4.4297353 0.5927899
#> 
#> [[4]]
#>  [1] 4.161295 4.100787 5.203617 2.834859 5.802465 1.590633 4.388598 5.400163
#>  [9] 2.324074 4.814966
#> 
#> [[5]]
#>  [1] 4.174221 4.122553 4.458257 4.057570 3.669375 5.454840 3.775409 4.406699
#>  [9] 4.623915 6.407320
#> 
#> [[6]]
#>  [1] 5.369359 5.013590 6.000731 6.724338 4.657999 6.667139 6.540117 6.250431
#>  [9] 5.368143 5.611131
#> 
#> [[7]]
#>  [1] 6.465108 6.069475 6.470768 7.833271 7.745595 5.673258 7.624571 6.511425
#>  [9] 7.453561 7.175354
#> 
#> [[8]]
#>  [1] 7.950262 7.219404 8.479617 7.063613 7.876795 7.910131 7.711917 7.618595
#>  [9] 7.993962 8.302159
#> 
#> [[9]]
#>  [1]  8.371420  9.303469  9.197193  9.746086  7.984000 12.576154  9.502340
#>  [8]  9.204455  9.406466  8.107886
#> 
#> [[10]]
#> 'miraiError' chr Error in (function (x) : stopped
```

2.  Retains information recorded in the error condition thrown:

``` r
1:10 |>
  mirai_map(\(x) if (x != 10) rnorm(10, x) else rlang::abort("stopped", meta = "uid")) |>
  collect_mirai() |>
  .subset2(10) |>
  attr("meta")
#> [1] "uid"
```

3.  Flatmap is an option:

``` r
1:10 |>
  mirai_map(\(x) {Sys.sleep(0.5); rnorm(10, x)}) |>
  collect_mirai(.flat)
#>   [1]  1.47031385  0.75007394  1.92306789  0.01929262  1.40934355  2.19775347
#>   [7] -0.06993167  0.46944086  0.81951535  0.82776805  3.88914406  2.52169177
#>  [13] -0.13261861  2.19545335  2.33961483  1.91904148  1.76372990  1.29720078
#>  [19]  1.25235543  2.27723702  3.70850061  2.59629773  1.17104844  4.91013065
#>  [25]  2.09292040  3.18635655  4.53813000  3.52821045  3.27343918  2.00415599
#>  [31]  3.79145608  3.38244797  4.27935314  5.43530253  4.57119476  4.42912546
#>  [37]  4.33599927  3.30836665  2.16394424  3.42385896  4.51821800  4.36200711
#>  [43]  6.48587122  6.09479999  4.39277899  4.52892766  5.64313994  4.10773795
#>  [49]  3.79561750  4.66660883  6.49942930  6.31061658  5.29852093  5.91254329
#>  [55]  7.36733658  6.82392632  6.20160626  6.86079771  6.88639296  6.86996675
#>  [61]  9.23032663  6.67782415  7.28407417  6.97457858  6.32898462  6.81579165
#>  [67]  6.55127891  7.54339147  6.32894634  7.06982393  7.25425497  8.97651908
#>  [73]  7.30055327  5.96054530  7.22286666  8.05876727  7.73377543  9.03499254
#>  [79]  8.67227421  7.02795720 10.48938319  8.65356274  9.09506216  7.40330711
#>  [85]  8.61756612  7.59455255  9.40155620  8.92630494 10.14224938  9.69957474
#>  [91] 12.01087267 10.31690242  8.90202492  9.58103133  8.78515428  9.86256907
#>  [97]  8.67894424  9.11763935 11.18907350  8.20167520
```
