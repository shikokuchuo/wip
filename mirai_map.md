
# mirai

#### Comparison of `mirai::mirai_map()` with `purrr::map()`

Setup:

``` r
library(purrr)
library(mirai)
daemons(2)
#> [1] 2
```

Basic example (identical):

``` r
1:10 |>
  map(\(x) rnorm(10, x))
#> [[1]]
#>  [1]  0.8713365  2.1291440 -0.3562123  1.8584176  1.4239666  0.5506725
#>  [7]  0.7825962  2.3661733  1.1822291  1.1093524
#> 
#> [[2]]
#>  [1] 1.6434841 1.5153270 2.9879523 0.9124614 4.1405446 1.0202855 2.5785411
#>  [8] 3.0414437 1.3661351 0.7876606
#> 
#> [[3]]
#>  [1] 3.4734804 3.5842610 5.2612198 0.7345056 1.5094652 3.0970451 4.1226086
#>  [8] 3.1501323 2.0832253 3.2572193
#> 
#> [[4]]
#>  [1] 4.966165 5.604783 4.369327 2.761947 4.699677 3.633717 4.176658 4.834331
#>  [9] 1.529967 5.754637
#> 
#> [[5]]
#>  [1] 4.803188 5.817282 4.474442 3.381734 5.002842 5.034924 5.598364 4.192055
#>  [9] 3.939634 5.584121
#> 
#> [[6]]
#>  [1] 7.758026 5.437038 5.242925 6.230396 6.141284 5.551752 6.495106 6.618574
#>  [9] 5.829430 5.884237
#> 
#> [[7]]
#>  [1] 6.705330 8.364306 6.840758 7.757486 7.684462 6.791464 5.163955 8.127580
#>  [9] 5.620800 5.799582
#> 
#> [[8]]
#>  [1] 7.553118 7.503784 7.185657 9.559346 7.638135 7.908927 6.423153 6.199706
#>  [9] 6.877210 8.072510
#> 
#> [[9]]
#>  [1] 8.123988 8.660824 9.224376 7.318743 9.824546 8.827732 7.115383 7.911581
#>  [9] 7.441657 8.698863
#> 
#> [[10]]
#>  [1] 11.601733 10.303477 10.254200  9.333618 10.716912  9.931867  9.223468
#>  [8] 10.123514 10.337391 11.535862

1:10 |>
  mirai_map(\(x) rnorm(10, x)) |>
  collect_mirai()
#> [[1]]
#>  [1] 1.0400965 2.4783037 1.3009325 0.3167541 1.4005645 0.4841706 0.2389738
#>  [8] 0.7282564 0.4107986 1.7378718
#> 
#> [[2]]
#>  [1] 1.886735 1.508258 1.378907 2.256749 1.636861 2.344983 4.142798 1.936963
#>  [9] 2.047895 2.321158
#> 
#> [[3]]
#>  [1] 4.493251 2.814340 3.434041 2.319915 3.211677 3.516923 2.431946 2.967751
#>  [9] 4.541261 1.719479
#> 
#> [[4]]
#>  [1] 3.369662 4.028274 3.992117 3.027345 4.095927 5.288925 3.404502 4.360439
#>  [9] 5.160092 4.410423
#> 
#> [[5]]
#>  [1] 6.245249 3.781177 5.446470 5.834115 4.046173 4.048132 5.513072 3.278783
#>  [9] 5.183518 5.198045
#> 
#> [[6]]
#>  [1] 5.487915 5.726126 6.318032 5.071748 6.681798 4.331639 5.865145 5.976264
#>  [9] 5.642815 5.781756
#> 
#> [[7]]
#>  [1] 5.912088 6.724370 5.495831 6.080653 6.354039 7.473620 6.314924 8.183714
#>  [9] 6.034774 6.655808
#> 
#> [[8]]
#>  [1] 8.558542 6.597576 7.183449 9.494845 7.217282 8.683794 7.142797 8.192388
#>  [9] 9.485807 7.215582
#> 
#> [[9]]
#>  [1]  9.130475  8.960453  6.736751  9.773858 10.194555 10.565686  8.529362
#>  [8]  8.775896  8.308478  9.221232
#> 
#> [[10]]
#>  [1]  9.138487  8.930389 10.596031  9.306853  8.791036  8.696413  9.287395
#>  [8] 10.452937 10.342216 10.094657
```

With cli progress bar (identical):

``` r
1:10 |>
  map(\(x) {Sys.sleep(0.5); rnorm(10, x)}, .progress = TRUE)
#> ■■■■■■■ 20% | ETA: 4s ■■■■■■■■■■ 30% | ETA: 4s ■■■■■■■■■■■■■ 40% | ETA: 3s
#> ■■■■■■■■■■■■■■■■ 50% | ETA: 3s ■■■■■■■■■■■■■■■■■■■ 60% | ETA: 2s
#> ■■■■■■■■■■■■■■■■■■■■■■ 70% | ETA: 2s ■■■■■■■■■■■■■■■■■■■■■■■■■ 80% | ETA: 1s
#> ■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 90% | ETA: 1s
#> [[1]]
#>  [1]  2.5357059  2.3881037  1.3070608  2.9892748 -0.7196846  0.7206150
#>  [7]  2.6258404  1.2276870  1.0362165 -0.7560677
#> 
#> [[2]]
#>  [1] 1.26371209 3.20012160 2.70045150 2.08256441 2.96137644 1.84488721
#>  [7] 0.60718281 3.39012189 0.05711615 2.53375960
#> 
#> [[3]]
#>  [1] 2.816386 4.740131 3.305114 3.100373 2.005955 2.788268 4.023541 3.885444
#>  [9] 1.594460 1.425389
#> 
#> [[4]]
#>  [1] 5.067882 3.211623 2.982258 3.214649 2.772416 4.772660 3.350465 5.013445
#>  [9] 2.236549 5.467993
#> 
#> [[5]]
#>  [1] 4.587253 4.184265 5.660293 2.607681 4.300004 6.210147 4.824645 5.722314
#>  [9] 4.866709 5.241902
#> 
#> [[6]]
#>  [1] 5.763904 5.810514 5.162600 4.178690 4.933308 6.651809 5.605615 7.601611
#>  [9] 5.433941 5.733794
#> 
#> [[7]]
#>  [1] 7.240849 5.539602 6.409280 6.107872 7.822371 7.500829 8.395035 6.663880
#>  [9] 5.802738 6.635544
#> 
#> [[8]]
#>  [1] 8.027539 6.950900 7.843912 6.998620 7.673186 8.029134 9.444136 7.350113
#>  [9] 8.058323 6.888247
#> 
#> [[9]]
#>  [1] 9.959990 8.421558 8.837082 8.594063 9.039202 6.340119 8.828693 8.687324
#>  [9] 7.637297 7.943705
#> 
#> [[10]]
#>  [1] 10.887971  9.982473 12.107375 10.599588 10.603151 10.020744 10.447532
#>  [8]  9.839970  9.374677 10.534053

1:10 |>
  mirai_map(\(x) {Sys.sleep(0.5); rnorm(10, x)}) |>
  collect_mirai(.progress)
#> ■■■■■■■■■■ 30% | ETA: 2s■■■■■■■■■■■■■■■■ 50% | ETA: 2s■■■■■■■■■■■■■■■■■■■■■■
#> 70% | ETA: 1s■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 90% | ETA: 0s
#> [[1]]
#>  [1] -1.9728803  1.1634531  0.7969797  1.3104596  1.6950091  1.9165334
#>  [7] -1.7910837  1.8687376  1.2839226  0.9783485
#> 
#> [[2]]
#>  [1] 2.147415 1.818970 1.259920 1.650687 1.767876 2.277205 2.098174 1.609786
#>  [9] 2.475497 2.624776
#> 
#> [[3]]
#>  [1] 2.749562 2.344658 2.025934 2.582366 4.203865 3.675800 2.209618 2.713882
#>  [9] 3.327641 3.574292
#> 
#> [[4]]
#>  [1] 1.799409 5.041720 2.734876 3.257676 4.399195 4.297045 2.456753 5.063114
#>  [9] 2.788956 4.412978
#> 
#> [[5]]
#>  [1] 4.895242 4.337727 4.388781 5.187058 4.574936 4.262954 5.806441 3.609031
#>  [9] 3.943645 4.072614
#> 
#> [[6]]
#>  [1] 7.046702 7.396768 7.358124 5.223265 5.468582 6.320436 5.445252 6.446662
#>  [9] 5.976564 4.428264
#> 
#> [[7]]
#>  [1] 6.747687 6.417889 6.801898 7.927365 6.411083 7.034854 7.565601 8.455344
#>  [9] 6.589561 8.601153
#> 
#> [[8]]
#>  [1] 8.272649 9.117908 7.173970 7.554744 9.449668 7.998816 8.013220 9.199927
#>  [9] 9.101427 8.466503
#> 
#> [[9]]
#>  [1] 11.127503  8.686515  8.306997  9.818608  8.216403  8.390803  8.019966
#>  [8]  9.122177 10.880279 10.187847
#> 
#> [[10]]
#>  [1]  8.236363 11.692732  9.212377 10.602380  9.473831  8.640836 10.558646
#>  [8]  9.635243 10.351243  9.333079
```

Error handling (now equivalent in latest mirai 2.0.0.9000):

``` r
1:10 |>
  map(\(x) if (x != 10) rnorm(10, x) else rlang::abort("stopped", meta = "uid"))
#> Error in `map()`:
#> ℹ In index: 10.
#> Caused by error in `.f()`:
#> ! stopped

1:10 |>
  mirai_map(\(x) if (x != 10) rnorm(10, x) else rlang::abort("stopped", meta = "uid")) |>
  collect_mirai(.stop)
#> Error in `mirai::mirai_map()`:
#> ℹ In index 10.
#> ✖ Error in (function (x) : stopped
```

Additional async features:

1.  Can recover non-errored portions if not using early stopping:

``` r
1:10 |>
  mirai_map(\(x) if (x != 10) rnorm(10, x) else rlang::abort("stopped", meta = "uid")) |>
  collect_mirai()
#> [[1]]
#>  [1]  1.42217858 -0.07569752  1.78523121  3.05177249  0.02846862 -0.46759720
#>  [7]  1.64152357  0.47320627  0.76032391  1.37140878
#> 
#> [[2]]
#>  [1]  1.6603087  2.9878705  1.8234246 -0.4795227  2.4734049  0.1960774
#>  [7]  0.5443213  1.1353814  0.8967413  2.0928228
#> 
#> [[3]]
#>  [1] 1.4882598 2.0493706 2.2943686 2.1730108 1.3097706 0.6942163 3.1019184
#>  [8] 3.6440778 3.3355858 2.7685793
#> 
#> [[4]]
#>  [1] 4.251498 3.155915 3.939147 3.903978 5.369272 4.947569 3.051640 6.120244
#>  [9] 3.410828 2.346435
#> 
#> [[5]]
#>  [1] 5.693740 5.769987 5.770250 3.507609 4.569197 5.979375 6.122754 6.168476
#>  [9] 6.365188 3.391638
#> 
#> [[6]]
#>  [1] 6.518106 4.719685 6.097588 7.079205 6.232290 7.778021 6.339394 5.155740
#>  [9] 4.629490 6.060721
#> 
#> [[7]]
#>  [1] 6.513127 7.249911 9.991740 6.975113 6.641099 6.242146 7.983630 8.878377
#>  [9] 8.003606 6.272762
#> 
#> [[8]]
#>  [1] 8.225971 7.366157 9.431366 7.971096 8.176193 9.087150 6.768530 7.561185
#>  [9] 7.144252 7.446332
#> 
#> [[9]]
#>  [1] 10.906140  8.908136  9.888361  9.147340  9.257311  9.910409  9.991263
#>  [8]  9.326461  8.918421 10.085963
#> 
#> [[10]]
#> 'miraiError' chr Error in (function (x) : stopped
```

2.  Retains information recorded in the error condition thrown:

``` r
1:10 |>
  mirai_map(\(x) if (x != 10) rnorm(10, x) else rlang::abort("stopped", meta = "uid")) |>
  collect_mirai() |>
  .subset2(10) |>
  attr("meta")
#> [1] "uid"
```

3.  Flatmap is an option:

``` r
1:10 |>
  mirai_map(\(x) {Sys.sleep(0.5); rnorm(10, x)}) |>
  collect_mirai(.flat)
#>   [1] -0.09359574  0.08942667  1.49722741  1.47292880  1.03015349  1.05801769
#>   [7]  1.46111137  1.43331247  1.31489736  0.80214454  2.49669489  1.95139655
#>  [13]  3.31656517  1.78802240  0.58591488  4.39875427  2.65496553  2.78712752
#>  [19]  2.80271632  0.40134638  4.16626267  3.98764974  2.12884791  2.43648140
#>  [25]  3.23225719  3.82593646  3.07178912  3.11791238  2.65122294  1.70719662
#>  [31]  3.36917345  4.88039625  5.29964939  2.91376542  4.34297447  3.05309602
#>  [37]  3.05902706  3.15997736  4.12756109  3.56079301  5.14200260  3.72381039
#>  [43]  4.28915977  6.76173339  4.48835987  4.03909888  4.37762375  4.28007435
#>  [49]  5.71998227  6.73904004  5.93283846  6.47756158  5.60983633  5.30565927
#>  [55]  6.43272816  7.21013875  5.55055342  7.62581910  6.38279226  6.81341561
#>  [61]  5.35749113  8.53570298  7.72374203  7.91905737  6.52256803  7.18315997
#>  [67]  7.37269336  8.38441256  8.23167491  6.48936692  8.33450184  7.50159498
#>  [73]  6.23280736  7.12484147  8.21509108  8.60692469  7.55633665  8.63625713
#>  [79]  7.79833170  8.35021955  9.18059657  9.78236943  9.70659188  7.51146573
#>  [85] 10.13893102  9.54065934  9.47729479  8.62292782  9.50208159  8.70373855
#>  [91]  9.72027462 10.18797552 10.85617393 10.32875034  9.02673354  7.78123450
#>  [97]  8.36791370 10.10813903 10.69373639  8.96941617
```
